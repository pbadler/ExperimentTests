rm(list=ls())
setwd("H:\\idahochart_remapping\\ipm")
allNames <- c("Artemisia tripartita","Hesperostipa comata","Poa secunda","Pseudoroegneria spicata")
allCodes <- c("ARTR","HECO","POSE","PSSP")
i=4
sppName <- allNames[i]
sppCode <- allCodes[i]
source("genet_nbhood_annuli_Other.r")
source("CreateDataFrames.r")
source('C:/Repos/ExperimentTests/removals/removal_analysis_wrapper.r')
source('H:/idahochart_remapping/ipm/flag_grasses_within_ARTR_removals.r')
source('H:/idahochart_remapping/ipm/flag_grasses_within_ARTR_removals.r')
source('C:/Repos/ExperimentTests/removals/removal_analysis_wrapper.r')
warnings()
# call all scripts for removal experiment analysis
rm(list=ls(all=TRUE))
graphics.off();
root=ifelse(.Platform$OS.type=="windows","c:/Repos","~/repos"); # modify as needed
setwd(paste(root,"/ExperimentTests/removals/",sep="")); # modify as needed
setwd("growth")
dists <- read.csv(paste0(root,"/ExperimentTests/data/idaho/speciesdata/IdahoDistanceWeights.csv"))
# PBA March 2016
# call from removal_analysis_wrapper.r
#########################################
#  1. Import data and calculate W's
#########################################
doSpp <- "POSE"
sppList <- c("ARTR","HECO","POSE","PSSP","allcov","allpts")
dataDir1 <- paste(root,"/ExperimentTests/data/idaho",sep="")
dataDir2 <- paste(root,"/ExperimentTests/data/idaho_modern",sep="")
nonCompLength.s=5 #Number of columns in SppData that are not measures of competitors
# set up distance weights------------------------------------------------
#dists <- read.csv(paste(dataDir2,"/speciesdata/IdahoModDistanceWeights_noExptl.csv",sep=""));
dists$allcov <- rowMeans(dists[,1:4])  # for "other" polygons use average of big 4
dists$allpts <- dists$POSE  # set forb dist wts = smallest grass (POSE)
# import old data--------------------------------------------------------
source("fetchGrowthData.r")
D1 <- fetchGdat(doSpp=doSpp,speciesList=sppList,datadir=dataDir1,distWts=dists)
D1$Treatment <- "Control"
# import modern data--------------------------------------------------------
D2 <- fetchGdat(doSpp=doSpp,speciesList=sppList,datadir=dataDir2,distWts=dists)
# merge in treatment data
tmp <- read.csv(paste(dataDir2,"/quad_info.csv",sep=""))
tmp <- tmp[,c("quad","Treatment")]
D2 <- merge(D2,tmp, all.x=T)
# account for removal in baseline years
if(doSpp!="ARTR"){
ii <- which(D2$year>=2011 & D2$Treatment=="No_shrub")
D2$W.ARTR[ii] <- 0
}else{
ii <- which(D2$year>=2011 & D2$Treatment=="No_grass")
D2$W.HECO[ii] <- 0 ; D2$W.POSE[ii] <- 0 ; D2$W.PSSP[ii] <- 0
}
# combine old and modern
allD <- rbind(D1,D2)
rm(D1,D2,tmp)
# merge data on removals at individual level
tmp <- read.csv(paste(dataDir2,"/speciesData/",doSpp,"/",doSpp,"_within_ARTRremovals.csv",sep=""))
tmp <- tmp[,c("quad","year","trackID","inARTR")]
allD<-merge(allD,tmp,all.x=T)
allD$inARTR[is.na(allD$inARTR)] <- 0
# clean up dataset ----------------------------------------------
allD$year[allD$year<2000] <- allD$year[allD$year<2000] + 1900
if(doSpp=="ARTR"){
keep <- which(is.element(allD$Treatment,c("Control","No_grass")))
}else{
keep <- which(is.element(allD$Treatment,c("Control","No_shrub")))
}
allD <- allD[keep,]
# remove outliers (large plants that obviously do not turn into tiny plants)
#########################################
#  2. Fit models
#########################################
library(lme4)
m1.lmer <- lmer(logarea.t1~logarea.t0+Treatment+W.ARTR + W.HECO + W.POSE + W.PSSP+ W.allcov + W.allpts +
(logarea.t0|year),data=allD)
summary(m1.lmer)
keep=which(allD$Treatment=="No_shrub") #  & allD$logarea.t0 > -1)
plot(allD$logarea.t0[keep],resid(m1.lmer)[keep])
summary(lm(resid(m1.lmer)[keep]~allD$logarea.t0[keep])) # NEG for POSE, zero for HECO (only 3 plots!), zero for PSSP
keep=which(allD$Treatment=="No_shrub")
plot(allD$W.POSE[keep],resid(m1.lmer)[keep])
summary(lm(resid(m1.lmer)[keep]~allD$W.POSE[keep])) # NEG for POSE, zero for HECO (only 3 plots!), zero for PSSP
plot(sqrt(allD$W.POSE[keep]),resid(m1.lmer)[keep])
# call from removal_analysis_wrapper.r
#########################################
#  1. Import data and calculate W's
#########################################
doSpp <- "PSSP"
sppList <- c("ARTR","HECO","POSE","PSSP","allcov","allpts")
dataDir1 <- paste(root,"/ExperimentTests/data/idaho",sep="")
dataDir2 <- paste(root,"/ExperimentTests/data/idaho_modern",sep="")
nonCompLength.s=5 #Number of columns in SppData that are not measures of competitors
# set up distance weights------------------------------------------------
#dists <- read.csv(paste(dataDir2,"/speciesdata/IdahoModDistanceWeights_noExptl.csv",sep=""));
dists$allcov <- rowMeans(dists[,1:4])  # for "other" polygons use average of big 4
dists$allpts <- dists$POSE  # set forb dist wts = smallest grass (POSE)
# import old data--------------------------------------------------------
source("fetchGrowthData.r")
D1 <- fetchGdat(doSpp=doSpp,speciesList=sppList,datadir=dataDir1,distWts=dists)
D1$Treatment <- "Control"
# import modern data--------------------------------------------------------
D2 <- fetchGdat(doSpp=doSpp,speciesList=sppList,datadir=dataDir2,distWts=dists)
# merge in treatment data
tmp <- read.csv(paste(dataDir2,"/quad_info.csv",sep=""))
tmp <- tmp[,c("quad","Treatment")]
D2 <- merge(D2,tmp, all.x=T)
# account for removal in baseline years
if(doSpp!="ARTR"){
ii <- which(D2$year>=2011 & D2$Treatment=="No_shrub")
D2$W.ARTR[ii] <- 0
}else{
ii <- which(D2$year>=2011 & D2$Treatment=="No_grass")
D2$W.HECO[ii] <- 0 ; D2$W.POSE[ii] <- 0 ; D2$W.PSSP[ii] <- 0
}
# combine old and modern
allD <- rbind(D1,D2)
rm(D1,D2,tmp)
# merge data on removals at individual level
tmp <- read.csv(paste(dataDir2,"/speciesData/",doSpp,"/",doSpp,"_within_ARTRremovals.csv",sep=""))
tmp <- tmp[,c("quad","year","trackID","inARTR")]
allD<-merge(allD,tmp,all.x=T)
allD$inARTR[is.na(allD$inARTR)] <- 0
# clean up dataset ----------------------------------------------
allD$year[allD$year<2000] <- allD$year[allD$year<2000] + 1900
if(doSpp=="ARTR"){
keep <- which(is.element(allD$Treatment,c("Control","No_grass")))
}else{
keep <- which(is.element(allD$Treatment,c("Control","No_shrub")))
}
allD <- allD[keep,]
# remove outliers (large plants that obviously do not turn into tiny plants)
#########################################
#  2. Fit models
#########################################
# set up indicator variables
allD$Treatment2 <- allD$Treatment
allD$Treatment2[allD$year>2000] <- "Modern"
allD$Treatment3 <- allD$Treatment
allD$Treatment3[allD$Treatment=="Control" & allD$year>2000] <- "ControlModern"
allD$year <- as.factor(allD$year)
m1.lmer <- lmer(logarea.t1~logarea.t0+Treatment+W.ARTR + W.HECO + W.POSE + W.PSSP+W.allcov + W.allpts+
(1|Group)+(logarea.t0|year),data=allD)
summary(m1.lmer)
keep=which(allD$Treatment=="No_shrub")
plot(sqrt(allD$W.PSSP[keep]),resid(m1.lmer)[keep])
keep=which(allD$Treatment=="No_shrub")
plot(allD$logarea.t0[keep],resid(m1.lmer)[keep])
summary(lm(resid(m1.lmer)[keep]~allD$logarea.t0[keep])) # NEG for POSE, zero for HECO (only 3 plots!), zero for PSSP
keep=which(allD$Treatment=="No_shrub"  & allD$logarea.t0 > -1))
keep=which(allD$Treatment=="No_shrub"  & allD$logarea.t0 > -1)
plot(allD$logarea.t0[keep],resid(m1.lmer)[keep])
summary(lm(resid(m1.lmer)[keep]~allD$logarea.t0[keep])) # NEG for POSE, zero for HECO (only 3 plots!), zero for PSSP
keep=which(allD$Treatment=="No_shrub")
plot(sqrt(allD$W.PSSP[keep]),resid(m1.lmer)[keep])
summary(lm(resid(m1.lmer)[keep]~allD$W.PSSP[keep])) # NEG for POSE, zero for HECO (only 3 plots!), zero for PSSP
m3.lmer<- lmer(logarea.t1~logarea.t0+Treatment+W.ARTR + W.HECO  + W.POSE + W.PSSP+W.PSSP*Treatment+ W.allcov + W.allpts+
(1|Group)+(logarea.t0|year),data=allD)
summary(m3.lmer) # SIGNIFICANT
# PBA March 2016
# call from removal_analysis_wrapper.r
#########################################
#  1. Import data and calculate W's
#########################################
doSpp <- "HECO"
sppList <- c("ARTR","HECO","POSE","PSSP","allcov","allpts")
dataDir1 <- paste(root,"/ExperimentTests/data/idaho",sep="")
dataDir2 <- paste(root,"/ExperimentTests/data/idaho_modern",sep="")
nonCompLength.s=5 #Number of columns in SppData that are not measures of competitors
# set up distance weights------------------------------------------------
#dists <- read.csv(paste(dataDir2,"/speciesdata/IdahoModDistanceWeights_noExptl.csv",sep=""));
dists$allcov <- rowMeans(dists[,1:4])  # for "other" polygons use average of big 4
dists$allpts <- dists$POSE  # set forb dist wts = smallest grass (POSE)
# import old data--------------------------------------------------------
source("fetchGrowthData.r")
D1 <- fetchGdat(doSpp=doSpp,speciesList=sppList,datadir=dataDir1,distWts=dists)
D1$Treatment <- "Control"
# import modern data--------------------------------------------------------
D2 <- fetchGdat(doSpp=doSpp,speciesList=sppList,datadir=dataDir2,distWts=dists)
# merge in treatment data
tmp <- read.csv(paste(dataDir2,"/quad_info.csv",sep=""))
tmp <- tmp[,c("quad","Treatment")]
D2 <- merge(D2,tmp, all.x=T)
# account for removal in baseline years
if(doSpp!="ARTR"){
ii <- which(D2$year>=2011 & D2$Treatment=="No_shrub")
D2$W.ARTR[ii] <- 0
}else{
ii <- which(D2$year>=2011 & D2$Treatment=="No_grass")
D2$W.HECO[ii] <- 0 ; D2$W.POSE[ii] <- 0 ; D2$W.PSSP[ii] <- 0
}
# combine old and modern
allD <- rbind(D1,D2)
rm(D1,D2,tmp)
# clean up dataset ----------------------------------------------
allD$year[allD$year<2000] <- allD$year[allD$year<2000] + 1900
if(doSpp=="ARTR"){
keep <- which(is.element(allD$Treatment,c("Control","No_grass")))
}else{
keep <- which(is.element(allD$Treatment,c("Control","No_shrub")))
}
allD <- allD[keep,]
# remove outliers (large plants that obviously do not turn into tiny plants)
#########################################
#  2. Fit models
#########################################
library(lme4)
# set up indicator variables
allD$Treatment2 <- allD$Treatment
allD$Treatment2[allD$year>2000] <- "Modern"
allD$Treatment3 <- allD$Treatment
allD$Treatment3[allD$Treatment=="Control" & allD$year>2000] <- "ControlModern"
allD$year <- as.factor(allD$year)
m1.lmer <- lmer(logarea.t1~logarea.t0+Treatment+W.ARTR + W.HECO + W.POSE + W.PSSP+W.allcov + W.allpts+
(1|Group)+(logarea.t0|year),data=allD)
m2.lmer<- lmer(logarea.t1~logarea.t0*Treatment+W.ARTR + W.HECO + W.POSE + W.PSSP+W.allcov + W.allpts+
(1|Group)+(logarea.t0|year),data=allD)
summary(m1.lmer)
summary(m2.lmer) # nope
m3.lmer<- lmer(logarea.t1~logarea.t0+Treatment+W.ARTR + W.HECO +W.HECO:Treatment + W.POSE + W.PSSP+W.allcov + W.allpts+
(1|Group)+(logarea.t0|year),data=allD)
summary(m3.lmer) # nope
keep=which(allD$Treatment=="No_shrub")
plot(allD$logarea.t0[keep],resid(m1.lmer)[keep])
summary(lm(resid(m1.lmer)[keep]~allD$logarea.t0[keep])) # NEG for POSE, zero for HECO (only 3 plots!), zero for PSSP
keep=which(allD$Treatment=="No_shrub")
plot(sqrt(allD$W.PSSP[keep]),resid(m1.lmer)[keep])
summary(lm(resid(m1.lmer)[keep]~allD$W.PSSP[keep])) # NEG for POSE, zero for HECO (only 3 plots!), zero for PSSP
# get survival predictions for Jacque; use data files in the
# ExperimentalTests repository
rm(list=ls(all=TRUE))
graphics.off();
root=ifelse(.Platform$OS.type=="windows","c:/Repos","~/repos"); # modify as needed
setwd(paste(root,"/ExperimentTests/removals/",sep="")); # modify as needed
library(lme4)
dists <- read.csv(paste0(root,"/ExperimentTests/data/idaho/speciesdata/IdahoDistanceWeights.csv"))
# do PSSP
setwd("survival")
#########################################
#  1. Import data and calculate W's
#########################################
doSpp <- "PSSP"
sppList <- c("ARTR","HECO","POSE","PSSP","allcov","allpts")
dataDir1 <- paste(root,"/ExperimentTests/data/idaho",sep="")
dataDir2 <- paste(root,"/ExperimentTests/data/idaho_modern",sep="")
nonCompLength.s=5 #Number of columns in SppData that are not measures of competitors
# set up distance weights------------------------------------------------
#dists <- read.csv(paste(dataDir2,"/speciesdata/IdahoModDistanceWeights_noExptl.csv",sep=""));
dists$allcov <- rowMeans(dists[,1:4])  # for "other" polygons use average of big 4
dists$allpts <- dists$POSE  # set forb dist wts = smallest grass (POSE)
# import old data--------------------------------------------------------
source("fetchSurvData.r")
D1 <- fetchSdat(doSpp=doSpp,speciesList=sppList,datadir=dataDir1,distWts=dists)
D1$Treatment <- "Control"
# import modern data--------------------------------------------------------
D2 <- fetchSdat(doSpp=doSpp,speciesList=sppList,datadir=dataDir2,distWts=dists)
# merge in treatment data
tmp <- read.csv(paste(dataDir2,"/quad_info.csv",sep=""))
tmp <- tmp[,c("quad","Treatment")]
D2 <- merge(D2,tmp, all.x=T)
# combine old and modern
allD <- rbind(D1,D2)
rm(D1,D2,tmp)
# clean up dataset
allD$year[allD$year<2000] <- allD$year[allD$year<2000] + 1900
sort(unique(allD$Treatment))
keep <- which(is.element(allD$Treatment,c("Control","Drought","Irrigation")))
allD <- allD[keep,]
sort(unique(allD$Treatment))
allD$year <- as.factor(allD$year)
out <- glmer(survives ~ logarea+ Treatment + W.ARTR + W.HECO + W.POSE + W.PSSP+ W.allcov + W.allpts
+ (logarea|year)+ (1|Group),data=allD,family="binomial")
out <- glmer(survives ~ logarea+ Treatment + W.ARTR + W.HECO + W.POSE + W.PSSP+ W.allcov + W.allpts
+ (logarea|year),data=allD,family="binomial")
summary(out)
plot(out)
out <- glmer(survives ~ logarea+ Treatment + W.ARTR + W.HECO + W.POSE + W.PSSP+ W.allcov + W.allpts
+ (logarea|year),data=allD,family="binomial",
InstEval,control = lmerControl(calc.derivs = FALSE))
out <- glmer(survives ~ logarea+ Treatment + W.ARTR + W.HECO + W.POSE + W.PSSP+ W.allcov + W.allpts
+ (logarea|year),data=allD,family="binomial",
InstEval,control = glmerControl(calc.derivs = FALSE))
out <- glmer(survives ~ logarea+ Treatment + W.ARTR + W.HECO + W.POSE + W.PSSP+ W.allcov + W.allpts
+ (logarea|year),data=allD,family="binomial",
control = glmerControl(calc.derivs = FALSE))
allDs<-allD
allDs[,c("logarea", "W.ARTR","W.HECO", "W.POSE","W.PSSP","W.allcov")]<-scale(allDs[,c("logarea", "W.ARTR","W.HECO", "W.POSE","W.PSSP","W.allcov")])
colMeans(allDs)
colMeans(allDs[,c("logarea", "W.ARTR","W.HECO", "W.POSE","W.PSSP","W.allcov")])
out <- glmer(survives ~ logarea+ Treatment + W.ARTR + W.HECO + W.POSE + W.PSSP+ W.allcov + W.allpts
+ (logarea|year)+ (1|Group),data=allDs,family="binomial") # doesn't converge
out <- glmer(survives ~ logarea+ Treatment + W.ARTR + W.HECO + W.POSE + W.PSSP+ W.allcov + W.allpts
+ (logarea|year),data=allDs,family="binomial")
allDs$pred <- predict(out,type="response")
head(allDs)
plot(allDs$survives,allDs$pred)
mean(allDs$pred[allDs$survives==0])
mean(allDs$pred[allDs$survives==1])
hist(allDs$logarea)
allDs <- subset(allDs,year>2000)
source('C:/Users/adler/Dropbox/ToDo/Pena/get_survival_predictions.r')
summary(out)
outfile<-paste0(outDir,"PSSP_surv_preds.csv")
outDir<-"C:/Users/adler/Dropbox/ToDo/Pena/"
outfile<-paste0(outDir,"PSSP_surv_preds.csv")
write.csv(out,outfile,row.names = F)
write.csv(allDs,outfile,row.names = F)
#  1. Import data and calculate W's
doSpp <- "POSE"
sppList <- c("ARTR","HECO","POSE","PSSP","allcov","allpts")
dataDir1 <- paste(root,"/ExperimentTests/data/idaho",sep="")
dataDir2 <- paste(root,"/ExperimentTests/data/idaho_modern",sep="")
nonCompLength.s=5 #Number of columns in SppData that are not measures of competitors
# set up distance weights------------------------------------------------
#dists <- read.csv(paste(dataDir2,"/speciesdata/IdahoModDistanceWeights_noExptl.csv",sep=""));
dists$allcov <- rowMeans(dists[,1:4])  # for "other" polygons use average of big 4
dists$allpts <- dists$POSE  # set forb dist wts = smallest grass (POSE)
# import old data
source("fetchSurvData.r")
D1 <- fetchSdat(doSpp=doSpp,speciesList=sppList,datadir=dataDir1,distWts=dists)
D1$Treatment <- "Control"
# import modern data
D2 <- fetchSdat(doSpp=doSpp,speciesList=sppList,datadir=dataDir2,distWts=dists)
# merge in treatment data
tmp <- read.csv(paste(dataDir2,"/quad_info.csv",sep=""))
tmp <- tmp[,c("quad","Treatment")]
D2 <- merge(D2,tmp, all.x=T)
# account for removal in baseline years
if(doSpp!="ARTR"){
ii <- which(D2$year>=2011 & D2$Treatment=="No_shrub")
D2$W.ARTR[ii] <- 0
}else{
ii <- which(D2$year>=2011 & D2$Treatment=="No_grass")
D2$W.HECO[ii] <- 0 ; D2$W.POSE[ii] <- 0 ; D2$W.PSSP[ii] <- 0
}
# combine old and modern
allD <- rbind(D1,D2)
rm(D1,D2,tmp)
# clean up dataset ----------------------------------------------
# clean up dataset
allD$year[allD$year<2000] <- allD$year[allD$year<2000] + 1900
keep <- which(is.element(allD$Treatment,c("Control","Drought","Irrigation")))
allD <- allD[keep,]
#  2. Fit models
# scale covariates
allDs<-allD
allDs[,c("logarea", "W.ARTR","W.HECO", "W.POSE","W.PSSP","W.allcov")]<-scale(allDs[,c("logarea", "W.ARTR","W.HECO", "W.POSE","W.PSSP","W.allcov")])
out <- glmer(survives ~ logarea+ Treatment + W.ARTR + W.HECO + W.POSE + W.PSSP+ W.allcov + W.allpts
+ (logarea|year)+ (1|Group),data=allDs,family="binomial") # doesn't converge
plot(out)
allDs$pred <- predict(out,type="response")
# write file, just modern years
allDs <- subset(allDs,year>2000)
outfile<-paste0(outDir,"POSE_surv_preds.csv")
write.csv(allDs,outfile,row.names = F)
